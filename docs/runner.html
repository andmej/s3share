<!DOCTYPE html>  <html> <head>   <title>runner.rb</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="args.html">                 args.rb               </a>                                           <a class="source" href="runner.html">                 runner.rb               </a>                                           <a class="source" href="s3share.html">                 s3share.rb               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               runner.rb             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="k">module</span> <span class="nn">S3Share</span>
  <span class="k">class</span> <span class="nc">Runner</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
      <span class="vi">@args</span> <span class="o">=</span> <span class="no">Args</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
      <span class="vi">@filename</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">first</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Print usage instructions if the filename is empty.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="vi">@filename</span><span class="o">.</span><span class="n">nil?</span>
        <span class="nb">puts</span> <span class="s2">&quot;usage: s3.rb [filename]&quot;</span>
        <span class="nb">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="vi">@path</span> <span class="o">=</span> <span class="n">get_directory</span>
      <span class="vi">@filename</span> <span class="o">=</span> <span class="n">clean_filename</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Upload the file and save the URL in the clipboard</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="n">exit_code</span> <span class="o">=</span> <span class="n">set_clipboard_url</span><span class="p">(</span><span class="n">upload_file</span><span class="p">)</span>
      <span class="nb">exit</span><span class="p">(</span><span class="n">exit_code</span><span class="p">)</span>
    <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>The user can specify absolute paths, relative paths and individual
filenames so we need to make sure we return the proper path to the
directory.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get_directory</span>
      <span class="k">if</span> <span class="o">!</span><span class="vi">@filename</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="c1"># single file name</span>
        <span class="s2">&quot;</span><span class="si">#{</span><span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="k">elsif</span> <span class="vi">@filename</span><span class="o">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;/&quot;</span> <span class="c1"># absolute path</span>
        <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">2</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="k">else</span>                        <span class="c1"># relative path</span>
        <span class="s2">&quot;</span><span class="si">#{</span><span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="vi">@filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">2</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="k">end</span>
    <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Returns only the filename, discarding any directory info.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">clean_filename</span>
      <span class="vi">@filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
    <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Uploads the file to Amazon S3 and returns the URL for the
object. Uploaded files are publicly readable.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">upload_file</span>
      <span class="n">bucket_name</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;AMAZON_S3_DEFAULT_BUCKET&quot;</span><span class="o">]</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span>
      <span class="n">access_key</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;AMAZON_ACCESS_KEY_ID&quot;</span><span class="o">]</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span>
      <span class="n">secret_key</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;AMAZON_SECRET_ACCESS_KEY&quot;</span><span class="o">]</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span>

      <span class="k">if</span> <span class="n">bucket_name</span><span class="o">.</span><span class="n">empty?</span>
        <span class="n">print_error</span><span class="p">(</span><span class="ss">:no_default_bucket</span><span class="p">)</span>
        <span class="nb">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="k">if</span> <span class="n">access_key</span><span class="o">.</span><span class="n">empty?</span> <span class="o">||</span> <span class="n">secret_key</span><span class="o">.</span><span class="n">empty?</span>
        <span class="n">print_error</span><span class="p">(</span><span class="ss">:wrong_aws_credentials</span><span class="p">)</span>
        <span class="nb">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="no">AWS</span><span class="o">::</span><span class="no">S3</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">establish_connection!</span><span class="p">(</span>
        <span class="ss">:access_key_id</span>     <span class="o">=&gt;</span> <span class="n">access_key</span><span class="p">,</span>
        <span class="ss">:secret_access_key</span> <span class="o">=&gt;</span> <span class="n">secret_key</span>
      <span class="p">)</span>

      <span class="no">AWS</span><span class="o">::</span><span class="no">S3</span><span class="o">::</span><span class="no">S3Object</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="vi">@filename</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@path</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="vi">@filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                              <span class="n">bucket_name</span><span class="p">,</span>
                              <span class="ss">:access</span> <span class="o">=&gt;</span> <span class="ss">:public_read</span><span class="p">)</span>

      <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://s3.amazonaws.com/</span><span class="si">#{</span><span class="n">bucket_name</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="vi">@filename</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> </span><span class="si">#{</span><span class="vi">@filename</span><span class="si">}</span><span class="s2"> uploaded to: </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
      <span class="n">url</span>
    <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Saves <code>url</code> in the clipboard for easy access. <code>#clipboard_cmd</code>
should be extended for other platforms (right now only OS X is
supported).</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">set_clipboard_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
      <span class="nb">system</span> <span class="s2">&quot;echo </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2"> | </span><span class="si">#{</span><span class="n">clipboard_cmd</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Returns the name of the command that allows you to pipe stuff
into the clipboard. <code>pbcopy</code> for OS X, no idea what it is in
other systems.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">clipboard_cmd</span>
      <span class="s2">&quot;pbcopy&quot;</span>
    <span class="k">end</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Finds an error by name and prints the associated error string.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">print_error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
      <span class="n">errors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="ss">:no_default_bucket</span> <span class="o">=&gt;</span>
        <span class="o">[</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ENV variable AMAZON_S3_DEFAULT_BUCKET has not been set.&quot;</span><span class="p">,</span>
         <span class="s2">&quot;Please run:&quot;</span><span class="p">,</span>
         <span class="s2">&quot;     export AMAZON_S3_DEFAULT_BUCKET=</span><span class="se">\&quot;</span><span class="s2">bucket-name</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
         <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Read the documentation for more information.</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">]</span><span class="p">,</span>
        <span class="ss">:wrong_aws_credentials</span> <span class="o">=&gt;</span>
        <span class="o">[</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">AWS credentials are invalid. Make sure that you have set the ENV:&quot;</span><span class="p">,</span>
         <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">     export AMAZON_ACCESS_KEY_ID=</span><span class="se">\&quot;</span><span class="s2">your-access-key</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
         <span class="s2">&quot;     export AMAZON_SECRET_ACCESS_KEY=</span><span class="se">\&quot;</span><span class="s2">your-secret-key</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
         <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Read the documentation for more information.</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">]</span>
      <span class="p">}</span>
      <span class="n">errors</span><span class="o">[</span><span class="n">err</span><span class="o">].</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span> <span class="nb">puts</span> <span class="n">msg</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 